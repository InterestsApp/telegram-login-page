<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í—Ö–æ–¥ –≤ GO –í–ú–ï–°–¢–ï</title>
    <style>
        body {
            background-color: #f2f2f2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: sans-serif;
        }
        h2 {
            margin-bottom: 20px;
            color: #333;
        }
        .note {
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h2>GO –í–ú–ï–°–¢–ï</h2>

    <!-- –í–ê–ñ–ù–û: data-onauth —Ç–µ–ø–µ—Ä—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞—à—É —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é -->
    <script
        async
        src="https://telegram.org/js/telegram-widget.js?22"
        data-telegram-login="InterestsApp_bot"
        data-size="large"
        data-userpic="false"
        data-request-access="write"
        data-lang="ru"
        data-onauth="handleTelegramLogin(user)">
    </script>

    <div class="note">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ –¥–ª—è –≤—Ö–æ–¥–∞</div>

<script>
    window.handleTelegramLogin = function(user) {
        console.log("Telegram login success:", user);

        // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Unicode (—Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤)
        // 1. –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –≤ JSON-—Å—Ç—Ä–æ–∫—É
        const userJson = JSON.stringify(user);
        
        // 2. –ö–æ–¥–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ base64 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Unicode
        //    –ò—Å–ø–æ–ª—å–∑—É–µ–º TextEncoder –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        function utf8ToBase64(str) {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É UTF-16 –≤ –±–∞–π—Ç—ã UTF-8
            const utf8Bytes = new TextEncoder().encode(str);
            // –ó–∞—Ç–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è btoa
            let binaryString = '';
            for (let i = 0; i < utf8Bytes.length; i++) {
                binaryString += String.fromCharCode(utf8Bytes[i]);
            }
            return btoa(binaryString);
        }
        
        const encodedData = utf8ToBase64(userJson);
        console.log("Encoded data length:", encodedData.length);

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è
        if (window.Android && typeof window.Android.onTelegramLogin === 'function') {
            console.log("Android app detected, calling native method");
            Android.onTelegramLogin(userJson); // –í Android —É—Ö–æ–¥–∏—Ç —á–∏—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            return;
        }

        // 3. –î–ª—è –≤–µ–±-–±—Ä–∞—É–∑–µ—Ä–∞ - —Ä–µ–¥–∏—Ä–µ–∫—Ç
        console.log("Web browser detected, redirecting...");
        
        // üëá –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–æ—Ä—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (3001 –∏–ª–∏ —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π)
        const webLoginUrl = 'http://localhost:3001/login';
        const redirectUrl = webLoginUrl + '#tgAuthResult=' + encodedData;
        console.log("Redirecting to:", redirectUrl);

        if (window.opener && !window.opener.closed) {
            window.opener.location.href = redirectUrl;
            window.close();
        } else {
            window.location.href = redirectUrl;
        }
    };
</script>
</body>
</html>
